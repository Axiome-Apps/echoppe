# Ã‰choppe - Production Docker Compose
#
# Quick start:
#   curl -O https://raw.githubusercontent.com/Axiome-Apps/echoppe/main/docker-compose.dist.yaml
#
#   # Generate encryption key (required for payment/shipping credentials)
#   export ENCRYPTION_KEY=$(openssl rand -base64 32)
#
#   docker compose -f docker-compose.dist.yaml up -d
#
# First run creates admin with ADMIN_EMAIL/ADMIN_PASSWORD

services:
  postgres:
    image: postgres:17-alpine
    container_name: echoppe-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: echoppe
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-echoppe}
      POSTGRES_DB: echoppe
    volumes:
      - echoppe-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U echoppe -d echoppe']
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: echoppe-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - echoppe-redis:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 5s
      retries: 5

  init:
    image: axiomeapp/echoppe-init:${VERSION:-latest}
    container_name: echoppe-init
    environment:
      DATABASE_URL: postgresql://echoppe:${POSTGRES_PASSWORD:-echoppe}@postgres:5432/echoppe
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"

  api:
    image: axiomeapp/echoppe-api:${VERSION:-latest}
    container_name: echoppe-api
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://echoppe:${POSTGRES_PASSWORD:-echoppe}@postgres:5432/echoppe
      REDIS_URL: redis://redis:6379
      ADMIN_URL: ${ADMIN_URL:-http://localhost:3211}
      STORE_URL: ${STORE_URL:-http://localhost:3141}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@echoppe.dev}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin123}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      UPLOAD_DIR: /app/uploads
    ports:
      - '${API_PORT:-7532}:7532'
    volumes:
      - echoppe-uploads:/app/uploads
    depends_on:
      init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy

  admin:
    image: axiomeapp/echoppe-admin:${VERSION:-latest}
    container_name: echoppe-admin
    restart: unless-stopped
    ports:
      - '${ADMIN_PORT:-3211}:80'
    depends_on:
      - api

  store:
    image: axiomeapp/echoppe-store:${VERSION:-latest}
    container_name: echoppe-store
    restart: unless-stopped
    ports:
      - '${STORE_PORT:-3141}:3000'
    depends_on:
      - api

volumes:
  echoppe-data:
  echoppe-redis:
  echoppe-uploads:
